name: Release

on:
  push:
    branches:
      - "main"
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cross compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Fetch Move Anything headers
        run: |
          git clone --depth 1 https://github.com/charlesvestal/move-anything.git .deps/move-anything

      - name: Build module tarball
        run: |
          chmod +x scripts/build.sh scripts/build-module.sh
          MOVE_ANYTHING_SRC="$GITHUB_WORKSPACE/.deps/move-anything/src" ./scripts/build-module.sh
          test -f dist/eucalypso-module.tar.gz

      - name: Verify GLIBC Compatibility
        run: |
          syms="$(strings dist/eucalypso/dsp.so | grep -oE 'GLIBC_[0-9]+\.[0-9]+' || true)"
          if [ -z "$syms" ]; then
            echo "No GLIBC symbols found in dsp.so (unexpected)."
            exit 1
          fi
          max_glibc="$(echo "$syms" | sed 's/GLIBC_//' | sort -V | tail -n 1)"
          echo "Max GLIBC symbol: $max_glibc"
          if [ "$(printf '%s\n' "$max_glibc" "2.17" | sort -V | tail -n 1)" != "2.17" ]; then
            echo "Incompatible GLIBC symbol version detected: $max_glibc (expected <= 2.17)"
            exit 1
          fi

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: |
            Fixed: published test release artifact for `${{ github.ref_name }}` from commit `${{ github.sha }}`.
            Not changed: no additional DSP/UI behavior changes were introduced while tagging this release.
          files: dist/eucalypso-module.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
